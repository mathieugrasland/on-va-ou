rules_version = '2';
// üîê Firestore Security Rules - FIX INSCRIPTION
// R√®gles simplifi√©es pour r√©soudre le probl√®me d'inscription

service cloud.firestore {
  match /databases/{database}/documents {
    // Collection users - Acc√®s contr√¥l√©
    match /users/{userId} {
      // Permettre √† un utilisateur de cr√©er/lire/modifier son propre profil
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Permettre les op√©rations d'amiti√© cross-user (envoi, acceptation, refus)
      allow update: if request.auth != null 
                    && request.auth.uid != userId
                    && resource.data.keys().hasAll(['friendRequests', 'friends'])
                    && request.resource.data.diff(resource.data).affectedKeys()
                       .hasOnly(['friendRequests', 'friends']);
      
      // Permettre la lecture limit√©e pour la recherche d'amis par email
      allow read: if request.auth != null;
    }
    
    // Collection friends - Relations d'amiti√©
    match /friends/{friendshipId} {
      allow read, write: if request.auth != null;
    }
    
    // Collection bars - Lecture publique
    match /bars/{barId} {
      allow read: if true;
      allow write: if false;
    }
    
    // Bloquer tout autre acc√®s par d√©faut
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
