<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Dashboard - On va o√π ? G√©rez vos amis et trouvez des bars">
    <meta name="theme-color" content="#5d4037">
    <title>Dashboard - On va o√π ?</title>
    <link rel="stylesheet" href="style.css">
    
    <!-- Firebase App (the core Firebase SDK) -->
    <script type="module">
        import { auth, db } from './firebase-config.js';
        import { loadGoogleMapsAPI } from './google-maps-config.js';
        import { onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';
        import { doc, getDoc, setDoc, collection, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';

        let currentUser = null;
        let userProfile = null;
        let map = null;
        let userMarkers = new Map(); // Stockage des marqueurs par uid
        let friendsData = []; // Donn√©es des amis avec g√©olocalisation

        // V√©rifier l'authentification
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await loadUserProfile();
                await loadDashboard();
            } else {
                window.location.href = 'login.html';
            }
        });

        // Charger le profil utilisateur
        async function loadUserProfile() {
            try {
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                if (userDoc.exists()) {
                    userProfile = userDoc.data();
                    
                    // V√©rifier si le profil est complet avant d'afficher le dashboard
                    const isProfileComplete = userProfile.profileCompleted && 
                                            userProfile.firstName?.trim() && 
                                            userProfile.lastName?.trim() && 
                                            userProfile.email?.trim() && 
                                            userProfile.address?.trim() && 
                                            userProfile.transportMode?.trim() && 
                                            userProfile.preferences?.trim();
                    
                    if (!isProfileComplete) {
                        // Rediriger vers le profil si incomplet
                        window.location.href = 'profile.html';
                        return;
                    }
                    
                    updateUserDisplay();
                } else {
                    console.error('Profil utilisateur introuvable');
                    showMessage('Impossible de charger votre profil', 'error');
                    window.location.href = 'profile.html';
                }
            } catch (error) {
                console.error('Erreur chargement profil:', error);
                showMessage('Erreur lors du chargement des donn√©es', 'error');
            }
        }

        // Mettre √† jour l'affichage utilisateur
        function updateUserDisplay() {
            if (userProfile) {
                const userNameElement = document.getElementById('user-name');
                if (userNameElement) {
                    userNameElement.textContent = `${userProfile.firstName} ${userProfile.lastName}`;
                }
                
                const userEmailElement = document.getElementById('user-email');
                if (userEmailElement) {
                    userEmailElement.textContent = userProfile.email;
                }
            }
        }

        // Charger le tableau de bord
        async function loadDashboard() {
            try {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('dashboard-content').classList.remove('hidden');
                
                // Charger Google Maps API et initialiser la carte
                await loadGoogleMapsAPI();
                await initializeMap();
                await loadFriendsOnMap();
                
            } catch (error) {
                console.error('Erreur chargement dashboard:', error);
                showMessage('Erreur lors du chargement du tableau de bord', 'error');
            }
        }

        // Initialiser la carte Google Maps
        async function initializeMap() {
            try {
                // Position par d√©faut (Paris)
                const defaultPosition = { lat: 48.8566, lng: 2.3522 };
                
                // Initialiser la carte Google Maps
                map = new google.maps.Map(document.getElementById('map'), {
                    center: defaultPosition,
                    zoom: 12,
                    mapTypeId: 'roadmap',
                    styles: [
                        {
                            featureType: 'poi.business',
                            elementType: 'labels',
                            stylers: [{ visibility: 'off' }]
                        }
                    ],
                    mapTypeControl: true,
                    streetViewControl: true,
                    fullscreenControl: true
                });
                
                // Masquer le loader de la carte
                document.getElementById('map-loading').style.display = 'none';
                
                console.log('‚úÖ Carte Google Maps initialis√©e');
                
                // G√©olocaliser l'utilisateur actuel
                await geocodeAndAddUser(userProfile, currentUser.uid, true);
                
            } catch (error) {
                console.error('Erreur initialisation carte:', error);
                showMessage('Erreur lors de l\'initialisation de la carte', 'error');
            }
        }

        // Charger les amis et les afficher sur la carte
        async function loadFriendsOnMap() {
            try {
                // Attendre que la carte soit initialis√©e
                if (!map) {
                    console.log('En attente de l\'initialisation de la carte...');
                    return;
                }
                
                if (!userProfile.friends || userProfile.friends.length === 0) {
                    console.log('Aucun ami √† afficher');
                    return;
                }

                console.log('Chargement des amis:', userProfile.friends);
                
                // Charger les donn√©es de chaque ami
                for (const friendUid of userProfile.friends) {
                    try {
                        const friendDoc = await getDoc(doc(db, 'users', friendUid));
                        if (friendDoc.exists()) {
                            const friendData = friendDoc.data();
                            await geocodeAndAddUser(friendData, friendUid, false);
                            await addFriendToPanel(friendData, friendUid);
                        }
                    } catch (error) {
                        console.error(`Erreur chargement ami ${friendUid}:`, error);
                    }
                }
                
            } catch (error) {
                console.error('Erreur chargement amis:', error);
            }
        }

        // G√©ocoder une adresse et ajouter l'utilisateur sur la carte
        async function geocodeAndAddUser(userData, uid, isCurrentUser = false) {
            try {
                if (!userData.address) {
                    console.log('Pas d\'adresse pour:', userData.firstName);
                    return;
                }

                console.log(`G√©ocodage de ${userData.firstName}: ${userData.address}`);
                
                // Utiliser le service de g√©ocodage Google Maps avec Promise
                const geocoder = new google.maps.Geocoder();
                
                return new Promise((resolve, reject) => {
                    geocoder.geocode({ address: userData.address }, (results, status) => {
                        if (status === 'OK' && results[0]) {
                            const location = results[0].geometry.location;
                            const lat = location.lat();
                            const lng = location.lng();
                            
                            // Cr√©er l'ic√¥ne personnalis√©e
                            const icon = {
                                url: `data:image/svg+xml;charset=UTF-8,${encodeURIComponent(`
                                    <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
                                        <circle cx="20" cy="20" r="18" fill="${isCurrentUser ? '#5d4037' : '#42a5f5'}" stroke="white" stroke-width="2"/>
                                        <text x="20" y="26" text-anchor="middle" fill="white" font-size="16">${isCurrentUser ? 'üè†' : 'üë§'}</text>
                                    </svg>
                                `)}`,
                                scaledSize: new google.maps.Size(40, 40),
                                anchor: new google.maps.Point(20, 20)
                            };
                            
                            // Cr√©er le marqueur
                            const marker = new google.maps.Marker({
                                position: { lat, lng },
                                map: map,
                                icon: icon,
                                title: `${userData.firstName} ${userData.lastName}`,
                                animation: google.maps.Animation.DROP
                            });
                            
                            // Cr√©er l'InfoWindow (popup)
                            const infoWindow = new google.maps.InfoWindow({
                                content: `
                                    <div class="marker-popup">
                                        <strong>${userData.firstName} ${userData.lastName}</strong><br>
                                        üìç ${userData.address}<br>
                                        üöó ${userData.transportMode || 'Non sp√©cifi√©'}
                                    </div>
                                `
                            });
                            
                            // Ajouter l'√©v√©nement click sur le marqueur
                            marker.addListener('click', () => {
                                // Fermer toutes les autres InfoWindows
                                userMarkers.forEach((markerData) => {
                                    if (markerData.infoWindow) {
                                        markerData.infoWindow.close();
                                    }
                                });
                                infoWindow.open(map, marker);
                            });
                            
                            // Stocker le marqueur avec son InfoWindow
                            userMarkers.set(uid, { marker, infoWindow });
                            
                            // Si c'est l'utilisateur actuel, centrer la carte
                            if (isCurrentUser) {
                                map.setCenter({ lat, lng });
                                map.setZoom(14);
                                document.getElementById('my-address').textContent = userData.address;
                            }
                            
                            console.log(`‚úÖ ${userData.firstName} ajout√© sur la carte`);
                            resolve();
                            
                        } else {
                            console.log(`‚ùå Adresse non trouv√©e pour ${userData.firstName}: ${userData.address}`);
                            console.log('Status:', status);
                            resolve(); // On r√©sout quand m√™me pour ne pas bloquer
                        }
                    });
                });
                
            } catch (error) {
                console.error(`Erreur g√©ocodage pour ${userData.firstName}:`, error);
            }
        }

        // Ajouter un ami au panel de s√©lection
        async function addFriendToPanel(friendData, friendUid) {
            const friendsList = document.getElementById('friends-list');
            const friendElement = document.createElement('div');
            friendElement.className = 'friend-item';
            friendElement.innerHTML = `
                <label class="friend-checkbox">
                    <input type="checkbox" id="friend-${friendUid}" checked onchange="toggleFriendMarker('${friendUid}')">
                    <span class="checkmark"></span>
                    <span class="friend-name">üë§ ${friendData.firstName} ${friendData.lastName}</span>
                    <span class="friend-address">${friendData.address || 'Adresse non sp√©cifi√©e'}</span>
                </label>
            `;
            friendsList.appendChild(friendElement);
        }

        // Afficher/masquer un marqueur d'ami
        function toggleFriendMarker(friendUid) {
            const checkbox = document.getElementById(`friend-${friendUid}`);
            const markerData = userMarkers.get(friendUid);
            
            if (markerData) {
                if (checkbox.checked) {
                    markerData.marker.setMap(map);
                } else {
                    markerData.marker.setMap(null);
                    markerData.infoWindow.close();
                }
            }
        }

        // Afficher/masquer sa propre position
        function toggleMyLocation() {
            const checkbox = document.getElementById('show-my-location');
            const markerData = userMarkers.get(currentUser.uid);
            
            if (markerData) {
                if (checkbox.checked) {
                    markerData.marker.setMap(map);
                } else {
                    markerData.marker.setMap(null);
                    markerData.infoWindow.close();
                }
            }
        }

        // D√©connexion
        async function logout() {
            try {
                await signOut(auth);
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Erreur d√©connexion:', error);
                showMessage('Erreur lors de la d√©connexion', 'error');
            }
        }

        // Fonction utilitaire pour afficher des messages
        function showMessage(message, type = 'success') {
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
            messageDiv.textContent = message;
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 1000;
                max-width: 400px;
                background: ${type === 'error' ? '#f44336' : '#4caf50'};
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Bouton d√©connexion
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', logout);
            }

            // Bouton profil
            const profileBtn = document.getElementById('profile-btn');
            if (profileBtn) {
                profileBtn.addEventListener('click', () => {
                    window.location.href = 'profile.html';
                });
            }

            // Checkbox pour ma position
            const myLocationCheckbox = document.getElementById('show-my-location');
            if (myLocationCheckbox) {
                myLocationCheckbox.addEventListener('change', toggleMyLocation);
            }
        });

        // Exposer les fonctions pour le d√©bogage et les √©v√©nements
        window.dashboardDebug = {
            auth,
            db,
            currentUser,
            userProfile,
            loadUserProfile,
            map,
            userMarkers
        };
        
        // Exposer les fonctions pour les √©v√©nements onclick
        window.toggleFriendMarker = toggleFriendMarker;
        window.toggleMyLocation = toggleMyLocation;
    </script>
</head>
<body>
    <div class="background-image"></div>
    <div class="container">
        
        <!-- Indicateur de chargement -->
        <div id="loading" class="loading">
            <h2>Chargement...</h2>
            <div class="loading-spinner">‚è≥</div>
        </div>

        <!-- Contenu du dashboard -->
        <div id="dashboard-content" class="dashboard-content hidden">
            <header class="dashboard-header">
                <div>
                    <h1>Dashboard</h1>
                    <p>Bienvenue <strong id="user-name">Utilisateur</strong></p>
                    <p id="user-email" class="user-email">email@exemple.com</p>
                </div>
                <div class="header-actions">
                    <button id="profile-btn" class="button button-secondary">
                        Mon Profil
                    </button>
                    <button id="logout-btn">D√©connexion</button>
                </div>
            </header>

            <!-- Section recherche de bars -->
            <section class="dashboard-section highlight">
                <h3>üó∫Ô∏è Carte des amis</h3>
                <div class="map-container">
                    <!-- Panel de s√©lection des amis -->
                    <div class="friends-panel">
                        <h4>üë• Mes amis</h4>
                        <div class="friends-selection">
                            <div class="friend-item my-location">
                                <label class="friend-checkbox">
                                    <input type="checkbox" id="show-my-location" checked>
                                    <span class="checkmark"></span>
                                    <span class="friend-name">üè† Ma position</span>
                                    <span class="friend-address" id="my-address">Chargement...</span>
                                </label>
                            </div>
                            <div id="friends-list">
                                <!-- Les amis seront ajout√©s ici dynamiquement -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Carte -->
                    <div class="map-wrapper">
                        <div id="map" class="map"></div>
                        <div class="map-loading" id="map-loading">
                            <div class="loading-spinner">üó∫Ô∏è</div>
                            <p>Chargement de la carte...</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>
</body>
</html>
