<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - On va o√π ?</title>
    <link rel="stylesheet" href="style.css">
    
    <!-- Firebase App (the core Firebase SDK) -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';
        import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyBs1O6cYYxNLE2vB9gEcmhEhONrditDyCo",
            authDomain: "on-va-ou-470217.firebaseapp.com",
            projectId: "on-va-ou-470217",
            storageBucket: "on-va-ou-470217.firebasestorage.app",
            messagingSenderId: "687464295451",
            appId: "1:687464295451:web:b228ea2a0ddc668e5f1cbe",
            measurementId: "G-2PCHXTT6DW"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let userProfile = null;

        // V√©rifier l'authentification
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await loadUserProfile();
                await loadDashboard();
            } else {
                window.location.href = 'login.html';
            }
        });

        // Charger le profil utilisateur
        async function loadUserProfile() {
            try {
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                if (userDoc.exists()) {
                    userProfile = userDoc.data();
                    updateUserDisplay();
                } else {
                    console.error('Profil utilisateur introuvable');
                }
            } catch (error) {
                console.error('Erreur chargement profil:', error);
            }
        }

        // Mettre √† jour l'affichage utilisateur
        function updateUserDisplay() {
            if (userProfile) {
                const userNameElement = document.getElementById('user-name');
                if (userNameElement) {
                    userNameElement.textContent = `${userProfile.firstName} ${userProfile.lastName}`;
                }
                
                const userEmailElement = document.getElementById('user-email');
                if (userEmailElement) {
                    userEmailElement.textContent = userProfile.email;
                }
            }
        }

        // Charger le tableau de bord
        async function loadDashboard() {
            try {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard-content').style.display = 'block';
                
                // Charger la liste des amis (√† impl√©menter)
                await loadFriends();
                
            } catch (error) {
                console.error('Erreur chargement dashboard:', error);
                showError('Erreur lors du chargement du tableau de bord');
            }
        }

        // Charger la liste des amis
        async function loadFriends() {
            try {
                const friendsList = document.getElementById('friends-list');
                
                // Pour l'instant, afficher un message
                friendsList.innerHTML = `
                    <div class="friends-placeholder">
                        <p>üöß Fonctionnalit√© amis en cours de d√©veloppement</p>
                        <p>Bient√¥t vous pourrez ajouter des amis et trouver des bars ensemble !</p>
                    </div>
                `;
                
            } catch (error) {
                console.error('Erreur chargement amis:', error);
            }
        }

        // G√©olocalisation
        async function getUserLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('G√©olocalisation non support√©e'));
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resolve({
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        });
                    },
                    (error) => {
                        reject(error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 300000
                    }
                );
            });
        }

        // D√©connexion
        async function logout() {
            try {
                await signOut(auth);
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Erreur d√©connexion:', error);
                alert('Erreur lors de la d√©connexion');
            }
        }

        // Afficher une erreur
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            errorDiv.style.cssText = `
                background: #f8d7da;
                color: #721c24;
                padding: 10px;
                border-radius: 5px;
                margin: 10px 0;
                border: 1px solid #f5c6cb;
            `;
            
            const container = document.querySelector('.container');
            container.insertBefore(errorDiv, container.firstChild);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Bouton d√©connexion
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', logout);
            }

            // Bouton localisation
            const locationBtn = document.getElementById('get-location-btn');
            if (locationBtn) {
                locationBtn.addEventListener('click', async () => {
                    try {
                        locationBtn.disabled = true;
                        locationBtn.textContent = 'Localisation...';
                        
                        const location = await getUserLocation();
                        
                        // Sauvegarder la localisation
                        await setDoc(doc(db, 'users', currentUser.uid), {
                            ...userProfile,
                            location: location,
                            locationUpdatedAt: new Date().toISOString()
                        });
                        
                        document.getElementById('location-status').textContent = 
                            `Position obtenue: ${location.latitude.toFixed(6)}, ${location.longitude.toFixed(6)}`;
                        
                        alert('Localisation mise √† jour avec succ√®s !');
                        
                    } catch (error) {
                        console.error('Erreur g√©olocalisation:', error);
                        alert('Erreur: ' + error.message);
                    } finally {
                        locationBtn.disabled = false;
                        locationBtn.textContent = 'Obtenir ma position';
                    }
                });
            }
        });

        // Exposer les fonctions pour le d√©bogage
        window.dashboardDebug = {
            auth,
            db,
            currentUser,
            userProfile,
            loadUserProfile,
            getUserLocation
        };
    </script>
</head>
<body>
    <div class="background-image"></div>
    <div class="container">
        
        <!-- Indicateur de chargement -->
        <div id="loading" style="text-align: center; padding: 50px;">
            <h2>Chargement...</h2>
            <div style="margin: 20px 0; font-size: 24px;">‚è≥</div>
        </div>

        <!-- Contenu du dashboard -->
        <div id="dashboard-content" style="display: none;">
            <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid var(--input-border);">
                <div>
                    <h1>Dashboard</h1>
                    <p>Bienvenue <strong id="user-name">...</strong></p>
                    <p style="color: var(--dark-text); opacity: 0.7;" id="user-email">...</p>
                </div>
                <button id="logout-btn" style="background: var(--primary-color); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                    D√©connexion
                </button>
            </header>

            <!-- Section localisation -->
            <section style="margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                <h3>üìç Ma localisation</h3>
                <p>Pour trouver les meilleurs bars, nous avons besoin de votre position actuelle.</p>
                <button id="get-location-btn" style="background: var(--accent-color); color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; margin: 10px 0;">
                    Obtenir ma position
                </button>
                <div id="location-status" style="margin-top: 10px; font-style: italic; color: var(--dark-text);"></div>
            </section>

            <!-- Section amis -->
            <section style="margin-bottom: 30px;">
                <h3>üë• Mes amis</h3>
                <div id="friends-list" style="margin-top: 15px;">
                    <!-- Les amis seront charg√©s ici -->
                </div>
            </section>

            <!-- Section recherche de bars -->
            <section style="margin-bottom: 30px; padding: 20px; background: #e8f5e8; border-radius: 10px;">
                <h3>üç∫ Trouver un bar</h3>
                <p>Fonctionnalit√© compl√®te bient√¥t disponible !</p>
                <p style="margin-top: 10px; font-style: italic;">
                    Vous pourrez bient√¥t ajouter des amis, voir leurs positions, et trouver le bar parfait au centre de votre groupe.
                </p>
            </section>
        </div>
    </div>
</body>
</html>
