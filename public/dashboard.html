<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Dashboard - On va o√π ? G√©rez vos amis et trouvez des bars">
    <meta name="theme-color" content="#5d4037">
    <title>Dashboard - On va o√π ?</title>
    <link rel="stylesheet" href="style.css">
    
    <!-- Firebase App (the core Firebase SDK) -->
    <script type="module">
        import { auth, db } from './firebase-config.js';
        import { onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';
        import { doc, getDoc, setDoc, collection, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';

        let currentUser = null;
        let userProfile = null;

        // V√©rifier l'authentification
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await loadUserProfile();
                await loadDashboard();
            } else {
                window.location.href = 'login.html';
            }
        });

        // Charger le profil utilisateur
        async function loadUserProfile() {
            try {
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                if (userDoc.exists()) {
                    userProfile = userDoc.data();
                    
                    // V√©rifier si le profil est complet avant d'afficher le dashboard
                    if (!userProfile.profileCompleted) {
                        // Rediriger vers le profil si incomplet
                        window.location.href = 'profile.html';
                        return;
                    }
                    
                    updateUserDisplay();
                } else {
                    console.error('Profil utilisateur introuvable');
                    showMessage('Impossible de charger votre profil', 'error');
                    window.location.href = 'profile.html';
                }
            } catch (error) {
                console.error('Erreur chargement profil:', error);
                showMessage('Erreur lors du chargement des donn√©es', 'error');
            }
        }

        // Mettre √† jour l'affichage utilisateur
        function updateUserDisplay() {
            if (userProfile) {
                const userNameElement = document.getElementById('user-name');
                if (userNameElement) {
                    userNameElement.textContent = `${userProfile.firstName} ${userProfile.lastName}`;
                }
                
                const userEmailElement = document.getElementById('user-email');
                if (userEmailElement) {
                    userEmailElement.textContent = userProfile.email;
                }
            }
        }

        // Charger le tableau de bord
        async function loadDashboard() {
            try {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('dashboard-content').classList.remove('hidden');
                
                // Charger la liste des amis (√† impl√©menter)
                await loadFriends();
                
            } catch (error) {
                console.error('Erreur chargement dashboard:', error);
                showError('Erreur lors du chargement du tableau de bord');
            }
        }

        // Charger la liste des amis
        async function loadFriends() {
            try {
                const friendsList = document.getElementById('friends-list');
                
                // Pour l'instant, afficher un message
                friendsList.innerHTML = `
                    <div class="friends-placeholder">
                        <p>üöß Fonctionnalit√© amis en cours de d√©veloppement</p>
                        <p>Bient√¥t vous pourrez ajouter des amis et trouver des bars ensemble !</p>
                    </div>
                `;
                
            } catch (error) {
                console.error('Erreur chargement amis:', error);
            }
        }

        // D√©connexion
        async function logout() {
            try {
                await signOut(auth);
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Erreur d√©connexion:', error);
                showMessage('Erreur lors de la d√©connexion', 'error');
            }
        }

        // Fonction utilitaire pour afficher des messages
        function showMessage(message, type = 'success') {
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
            messageDiv.textContent = message;
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 1000;
                max-width: 400px;
                background: ${type === 'error' ? '#f44336' : '#4caf50'};
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Bouton d√©connexion
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', logout);
            }

            // Bouton profil
            const profileBtn = document.getElementById('profile-btn');
            if (profileBtn) {
                profileBtn.addEventListener('click', () => {
                    window.location.href = 'profile.html';
                });
            }
        });

        // Exposer les fonctions pour le d√©bogage
        window.dashboardDebug = {
            auth,
            db,
            currentUser,
            userProfile,
            loadUserProfile
        };
    </script>
</head>
<body>
    <div class="background-image"></div>
    <div class="container">
        
        <!-- Indicateur de chargement -->
        <div id="loading" class="loading">
            <h2>Chargement...</h2>
            <div class="loading-spinner">‚è≥</div>
        </div>

        <!-- Contenu du dashboard -->
        <div id="dashboard-content" class="dashboard-content hidden">
            <header class="dashboard-header">
                <div>
                    <h1>Dashboard</h1>
                    <p>Bienvenue <strong id="user-name">Utilisateur</strong></p>
                    <p id="user-email" class="user-email">email@exemple.com</p>
                </div>
                <div class="header-actions">
                    <button id="profile-btn" class="button button-secondary">
                        Mon Profil
                    </button>
                    <button id="logout-btn">D√©connexion</button>
                </div>
            </header>

            <!-- Section amis -->
            <section class="dashboard-section">
                <h3>üë• Mes amis</h3>
                <div id="friends-list">
                    <!-- Les amis seront charg√©s ici -->
                </div>
            </section>

            <!-- Section recherche de bars -->
            <section class="dashboard-section highlight">
                <h3>üç∫ Trouver un bar</h3>
                <p>Fonctionnalit√© compl√®te bient√¥t disponible !</p>
                <p class="mt-1 text-italic">
                    Vous pourrez bient√¥t ajouter des amis, voir leurs positions, et trouver le bar parfait au centre de votre groupe.
                </p>
            </section>
        </div>
    </div>
</body>
</html>
