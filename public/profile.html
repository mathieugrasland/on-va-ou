<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Profil utilisateur - On va o√π ? Compl√©tez vos informations">
    <meta name="theme-color" content="#5d4037">
    <title>Mon Profil - On va o√π ?</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="manifest" href="/manifest.json">
    <link rel="manifest" href="/site.webmanifest">
    
    <link rel="stylesheet" href="style.css">
    
    <style>
        /* Wrapper sp√©cifique au profil - vraiment responsive */
        .profile-wrapper {
            width: 100%;
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        /* Header commun */
        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px) saturate(1.2);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 15px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            margin: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-update {
            background: none;
            border: none;
            color: #2196F3;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 8px;
            border-radius: 12px;
            min-width: 36px;
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-update:hover {
            background: rgba(33, 150, 243, 0.1);
            transform: scale(1.05) rotate(180deg);
        }

        .nav-icon {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: 12px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
            min-height: 40px;
        }

        .nav-icon:hover {
            background: rgba(93, 64, 55, 0.1);
            transform: scale(1.05);
        }

        .nav-current {
            background: rgba(93, 64, 55, 0.15);
            cursor: default;
        }

        .nav-current:hover {
            transform: none;
        }

        .nav-logout {
            background: none;
            border: none;
            color: #EA4335;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 8px;
            border-radius: 12px;
            min-width: 40px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-logout:hover {
            background: rgba(234, 67, 53, 0.1);
            transform: scale(1.05);
        }

        /* Container principal responsive */
        .profile-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            box-sizing: border-box;
        }

        /* Formulaire responsive en grid */
        .profile-form {
            display: grid;
            gap: 30px;
            grid-template-columns: 1fr;
        }

        /* Sections du formulaire */
        .form-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px) saturate(1.2);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .form-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .form-section h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: var(--primary-color);
            font-weight: 600;
            font-size: 20px;
        }

        /* Layout 2 colonnes sur desktop */
        @media (min-width: 1024px) {
            .profile-form {
                grid-template-columns: 1fr 1fr;
                gap: 40px;
            }
            
            .profile-content {
                padding: 0 40px;
            }
        }

        /* Tablet layout */
        @media (min-width: 769px) and (max-width: 1023px) {
            .profile-content {
                max-width: 900px;
                padding: 0 30px;
            }
            
            .profile-form {
                grid-template-columns: 1fr;
            }
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .profile-wrapper {
                padding: 0px 0;
            }
            
            .profile-content {
                padding: 0 15px;
            }
            
            .profile-header {
                padding: 20px;
                flex-direction: column;
                text-align: center;
                align-items: center;
                gap: 15px;
            }
            
            .profile-header h1 {
                font-size: 24px;
            }
            
            .header-actions {
                justify-content: center;
                width: 100%;
            }
            
            .form-section {
                padding: 20px;
                border-radius: 15px;
            }
            
            .form-section h3 {
                font-size: 18px;
            }
            
            .form-row {
                flex-direction: column;
            }
        }

        /* Section amis responsive */
        .friends-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px) saturate(1.2);
            border-radius: 20px;
            padding: 30px;
            margin-top: 30px;
            margin-bottom: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .friends-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        /* Loading screen am√©lior√© */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .loading.hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* Classe hidden globale */
        .hidden {
            display: none !important;
        }

        /* Boutons responsifs */
        .button, .button-secondary, .button-logout {
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }

        /* Centrer le bouton de sauvegarde */
        .form-actions {
            text-align: center;
            padding: 20px 0;
        }

        @media (max-width: 768px) {
            .navbar {
                padding: 10px 15px;
            }

            .nav-left {
                gap: 15px;
            }

            .nav-icon {
                font-size: 20px;
                min-width: 36px;
                min-height: 36px;
            }

            .nav-logout {
                font-size: 20px;
                min-width: 36px;
                min-height: 36px;
            }

            .button, .button-secondary, .button-logout {
                padding: 10px 20px;
                font-size: 13px;
            }
        }
    </style>
    
    <!-- Firebase App (the core Firebase SDK) -->
    <script type="module">
        // Import du gestionnaire de mises √† jour simplifi√© (temporaire)
        import './js/simple-update-manager.js';
        
        import { auth, db } from './firebase-config.js';
        import { onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
        import { doc, getDoc, setDoc, updateDoc, collection, query, where, getDocs, arrayUnion, arrayRemove, runTransaction } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

        // Fonction utilitaire pour afficher des messages
        function showMessage(message, type = 'success') {
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'error' ? 'error-message' : 
                                 type === 'warning' ? 'warning-message' : 'success-message';
            messageDiv.textContent = message;
            
            let backgroundColor;
            switch(type) {
                case 'error': backgroundColor = '#f44336'; break;
                case 'warning': backgroundColor = '#ff9800'; break;
                default: backgroundColor = '#4caf50'; break;
            }
            
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 1000;
                max-width: 400px;
                background: ${backgroundColor};
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        let currentUser = null;
        let userProfile = null;
        let isNewUser = false;

        // V√©rifier l'authentification
        onAuthStateChanged(auth, async (user) => {
            console.log('onAuthStateChanged triggered:', user ? user.email : 'no user');
            if (user) {
                currentUser = user;
                await loadUserProfile();
            } else {
                console.log('No user found, redirecting to login');
                window.location.href = 'login.html';
            }
        });

        // Charger le profil utilisateur
        async function loadUserProfile() {
            console.log('Loading user profile for:', currentUser.uid);
            try {
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                console.log('User document exists:', userDoc.exists());
                if (userDoc.exists()) {
                    userProfile = userDoc.data();
                    
                    // V√©rifier et r√©parer la structure du profil
                    const needsRepair = await checkAndRepairProfile();
                    
                    // Distinguer entre "vraiment nouveau" (pas de firstName/lastName) et "profil incomplet"
                    const hasBasicInfo = userProfile.firstName?.trim() && userProfile.lastName?.trim();
                    const hasCompleteProfile = hasBasicInfo && 
                                             userProfile.address?.trim() && 
                                             userProfile.transportMode?.trim() && 
                                             userProfile.preferences?.trim();
                    
                    // Si l'utilisateur a au moins un nom/pr√©nom, ne pas le traiter comme "nouveau"
                    isNewUser = !hasBasicInfo;
                    
                    console.log('Profile check:', {
                        needsRepair,
                        hasBasicInfo,
                        hasCompleteProfile,
                        isNewUser,
                        profileCompleted: userProfile.profileCompleted,
                        firstName: userProfile.firstName,
                        lastName: userProfile.lastName
                    });
                    
                    updateUI();
                    hideLoading();
                    
                    // Charger les amis seulement si le profil est structurellement valide
                    if (!needsRepair) {
                        await loadFriends();
                    }
                } else {
                    // Nouvel utilisateur - cr√©er un profil par d√©faut
                    console.log('Nouveau utilisateur d√©tect√©, cr√©ation du profil par d√©faut...');
                    
                    userProfile = {
                        firstName: '',
                        lastName: '',
                        email: currentUser.email || '',
                        createdAt: new Date().toISOString(),
                        profileCompleted: false,
                        address: '',
                        transportMode: '',
                        preferences: '',
                        friends: [],
                        friendRequests: {
                            sent: [],
                            received: []
                        }
                    };
                    
                    try {
                        await setDoc(doc(db, 'users', currentUser.uid), userProfile);
                        console.log('Profil par d√©faut cr√©√© avec succ√®s');
                    } catch (error) {
                        console.error('Erreur cr√©ation profil par d√©faut:', error);
                        showMessage('Erreur lors de la cr√©ation du profil', 'error');
                    }
                    
                    isNewUser = true;
                    updateUI();
                    hideLoading();
                }
            } catch (error) {
                console.error('Erreur chargement profil:', error);
                showMessage('Erreur lors du chargement des donn√©es', 'error');
                hideLoading(); // Important : arr√™ter le loading m√™me en cas d'erreur
            }
        }

        // V√©rifier et r√©parer la structure du profil
        async function checkAndRepairProfile() {
            let needsUpdate = false;
            let updates = {};
            
            // V√©rifier les champs obligatoires manquants
            if (!userProfile.friends) {
                updates.friends = [];
                needsUpdate = true;
            }
            
            if (!userProfile.friendRequests) {
                updates.friendRequests = { sent: [], received: [] };
                needsUpdate = true;
            }
            
            if (!userProfile.firstName) {
                updates.firstName = '';
                needsUpdate = true;
            }
            
            if (!userProfile.lastName) {
                updates.lastName = '';
                needsUpdate = true;
            }
            
            if (!userProfile.email) {
                updates.email = currentUser.email || '';
                needsUpdate = true;
            }
            
            if (!userProfile.address) {
                updates.address = '';
                needsUpdate = true;
            }
            
            if (!userProfile.transportMode) {
                updates.transportMode = '';
                needsUpdate = true;
            }
            
            if (!userProfile.preferences) {
                updates.preferences = '';
                needsUpdate = true;
            }
            
            // Logique simplifi√©e pour profileCompleted
            const allCurrentFields = {
                firstName: userProfile.firstName || updates.firstName,
                lastName: userProfile.lastName || updates.lastName,
                email: userProfile.email || updates.email,
                address: userProfile.address || updates.address,
                transportMode: userProfile.transportMode || updates.transportMode,
                preferences: userProfile.preferences || updates.preferences
            };
            
            const hasAllRequiredFields = allCurrentFields.firstName?.trim() && 
                                        allCurrentFields.lastName?.trim() && 
                                        allCurrentFields.email?.trim() && 
                                        allCurrentFields.address?.trim() && 
                                        allCurrentFields.transportMode?.trim() && 
                                        allCurrentFields.preferences?.trim();
            
            // D√©terminer la valeur correcte pour profileCompleted
            const shouldBeCompleted = hasAllRequiredFields;
            
            if (userProfile.profileCompleted !== shouldBeCompleted) {
                updates.profileCompleted = shouldBeCompleted;
                needsUpdate = true;
            }
            
            // Appliquer les mises √† jour si n√©cessaire
            if (needsUpdate) {
                try {
                    await updateDoc(doc(db, 'users', currentUser.uid), updates);
                    // Mettre √† jour le profil local
                    userProfile = { ...userProfile, ...updates };
                    console.log('Profil r√©par√© automatiquement:', updates);
                } catch (error) {
                    console.error('Erreur r√©paration profil:', error);
                }
            }
            
            return needsUpdate;
        }

        // Mettre √† jour l'interface
        function updateUI() {
            // Remplir les champs du formulaire
            const firstNameInput = document.getElementById('profile-firstName');
            const lastNameInput = document.getElementById('profile-lastName');
            const emailInput = document.getElementById('profile-email');
            const addressInput = document.getElementById('profile-address');
            const transportInput = document.getElementById('profile-transport');
            const preferencesInput = document.getElementById('profile-preferences');

            if (firstNameInput) firstNameInput.value = userProfile.firstName || '';
            if (lastNameInput) lastNameInput.value = userProfile.lastName || '';
            if (emailInput) emailInput.value = userProfile.email || '';
            if (addressInput) addressInput.value = userProfile.address || '';
            if (transportInput) transportInput.value = userProfile.transportMode || '';
            if (preferencesInput) preferencesInput.value = userProfile.preferences || '';
        }

        // V√©rifier si le profil est complet
        function isProfileComplete() {
            return userProfile.profileCompleted && 
                   userProfile.firstName?.trim() && 
                   userProfile.lastName?.trim() && 
                   userProfile.email?.trim() && 
                   userProfile.address?.trim() && 
                   userProfile.transportMode?.trim() && 
                   userProfile.preferences?.trim();
        }

        // Charger la liste des amis et demandes
        async function loadFriends() {
            try {
                // D'abord synchroniser les donn√©es pour nettoyer les incoh√©rences
                const hasChanges = await syncFriendRequestsData();
                
                // Recharger le profil si des corrections ont √©t√© apport√©es
                if (hasChanges) {
                    const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                    if (userDoc.exists()) {
                        userProfile = userDoc.data();
                    }
                }
                
                await loadFriendRequests();
                await loadConfirmedFriends();
            } catch (error) {
                console.error('Erreur chargement amis:', error);
            }
        }

        // Charger les demandes d'amiti√©
        async function loadFriendRequests() {
            try {
                // Demandes re√ßues
                const receivedContainer = document.getElementById('received-requests');
                const sentContainer = document.getElementById('sent-requests');
                
                // Assurer la structure correcte des friendRequests
                if (!userProfile.friendRequests) {
                    userProfile.friendRequests = { sent: [], received: [] };
                } else if (Array.isArray(userProfile.friendRequests)) {
                    // Migration de l'ancien syst√®me vers le nouveau
                    console.log('Migration de l\'ancien syst√®me d√©tect√©e');
                    userProfile.friendRequests = { 
                        sent: [], 
                        received: userProfile.friendRequests 
                    };
                } else {
                    // Assurer que les propri√©t√©s existent
                    if (!userProfile.friendRequests.sent) userProfile.friendRequests.sent = [];
                    if (!userProfile.friendRequests.received) userProfile.friendRequests.received = [];
                }
                
                if (userProfile.friendRequests) {
                    // Demandes re√ßues
                    if (userProfile.friendRequests.received && userProfile.friendRequests.received.length > 0) {
                        const receivedHTML = await Promise.all(
                            userProfile.friendRequests.received.map(async (senderUid) => {
                                try {
                                    const senderDoc = await getDoc(doc(db, 'users', senderUid));
                                    if (senderDoc.exists()) {
                                        const senderData = senderDoc.data();
                                        return `
                                            <div class="friend-request-item">
                                                <span class="friend-name">${senderData.firstName} ${senderData.lastName}</span>
                                                <span class="friend-email">(${senderData.email})</span>
                                                <div class="request-actions">
                                                    <button onclick="acceptFriendRequest('${senderUid}')" class="button-small button-accept">Accepter</button>
                                                    <button onclick="rejectFriendRequest('${senderUid}')" class="button-small button-reject">Refuser</button>
                                                </div>
                                            </div>
                                        `;
                                    } else {
                                        console.warn('Utilisateur non trouv√©:', senderUid);
                                        return '';
                                    }
                                } catch (error) {
                                    console.error('Erreur chargement exp√©diteur:', senderUid, error);
                                    return '';
                                }
                            })
                        );
                        receivedContainer.innerHTML = receivedHTML.join('');
                    } else {
                        receivedContainer.innerHTML = '<p class="no-requests">Aucune demande re√ßue</p>';
                    }

                    // Demandes envoy√©es
                    if (userProfile.friendRequests.sent && userProfile.friendRequests.sent.length > 0) {
                        const sentHTML = await Promise.all(
                            userProfile.friendRequests.sent.map(async (recipientUid) => {
                                const recipientDoc = await getDoc(doc(db, 'users', recipientUid));
                                const recipientData = recipientDoc.data();
                                return `
                                    <div class="friend-request-item">
                                        <span class="friend-name">${recipientData.firstName} ${recipientData.lastName}</span>
                                        <span class="friend-email">(${recipientData.email})</span>
                                        <span class="request-status">En attente...</span>
                                    </div>
                                `;
                            })
                        );
                        sentContainer.innerHTML = sentHTML.join('');
                    } else {
                        sentContainer.innerHTML = '<p class="no-requests">Aucune demande envoy√©e</p>';
                    }
                } else {
                    receivedContainer.innerHTML = '<p class="no-requests">Aucune demande re√ßue</p>';
                    sentContainer.innerHTML = '<p class="no-requests">Aucune demande envoy√©e</p>';
                }
            } catch (error) {
                console.error('Erreur chargement demandes:', error);
            }
        }

        // Charger les amis confirm√©s
        async function loadConfirmedFriends() {
            try {
                const friendsList = document.getElementById('friends-list');
                
                if (userProfile.friends && userProfile.friends.length > 0) {
                    const friendsHTML = await Promise.all(
                        userProfile.friends.map(async (friendUid) => {
                            const friendDoc = await getDoc(doc(db, 'users', friendUid));
                            const friendData = friendDoc.data();
                            return `
                                <div class="friend-item">
                                    <div class="friend-info">
                                        <span class="friend-name">${friendData.firstName} ${friendData.lastName}</span>
                                        <span class="friend-email">(${friendData.email})</span>
                                    </div>
                                    <button onclick="removeFriend('${friendUid}')" class="button-small button-remove">Supprimer</button>
                                </div>
                            `;
                        })
                    );
                    friendsList.innerHTML = friendsHTML.join('');
                } else {
                    friendsList.innerHTML = '<p class="no-friends">Aucun ami pour le moment</p>';
                }
            } catch (error) {
                console.error('Erreur chargement amis confirm√©s:', error);
            }
        }

        // Rechercher un utilisateur par email et envoyer une demande d'amiti√©
        async function sendFriendRequest(email) {
            try {
                // V√©rifier que ce n'est pas son propre email
                if (email === currentUser.email) {
                    showMessage('Vous ne pouvez pas vous ajouter vous-m√™me !', 'error');
                    return;
                }

                // Rechercher l'utilisateur par email
                const usersRef = collection(db, 'users');
                const q = query(usersRef, where('email', '==', email));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    showMessage('Aucun utilisateur trouv√© avec cette adresse email', 'error');
                    return;
                }

                const targetUserDoc = querySnapshot.docs[0];
                const targetUserData = targetUserDoc.data();
                const targetUid = targetUserDoc.id;

                // V√©rifier que les utilisateurs ne sont pas d√©j√† amis
                if (userProfile.friends && userProfile.friends.includes(targetUid)) {
                    showMessage('Vous √™tes d√©j√† amis avec cette personne', 'error');
                    return;
                }

                // V√©rifier qu'une demande n'a pas d√©j√† √©t√© envoy√©e
                if (userProfile.friendRequests && userProfile.friendRequests.sent && userProfile.friendRequests.sent.includes(targetUid)) {
                    showMessage('Demande d√©j√† envoy√©e √† cette personne', 'error');
                    return;
                }

                // V√©rifier qu'une demande n'a pas d√©j√† √©t√© re√ßue de cette personne
                if (userProfile.friendRequests && userProfile.friendRequests.received && userProfile.friendRequests.received.includes(targetUid)) {
                    showMessage('Cette personne vous a d√©j√† envoy√© une demande ! V√©rifiez vos demandes re√ßues.', 'error');
                    return;
                }

                // Utiliser une transaction pour garantir la coh√©rence
                console.log('üì§ Envoi demande d\'amiti√© √†:', targetUid);
                
                await runTransaction(db, async (transaction) => {
                    // Lire les documents actuels
                    const currentUserDoc = await transaction.get(doc(db, 'users', currentUser.uid));
                    const targetUserDoc = await transaction.get(doc(db, 'users', targetUid));
                    
                    if (!currentUserDoc.exists() || !targetUserDoc.exists()) {
                        throw new Error('Utilisateur non trouv√©');
                    }
                    
                    const currentUserData = currentUserDoc.data();
                    const targetUserData = targetUserDoc.data();
                    
                    // V√©rifications finales dans la transaction
                    const currentRequests = currentUserData.friendRequests || { sent: [], received: [] };
                    const targetRequests = targetUserData.friendRequests || { sent: [], received: [] };
                    
                    if ((currentUserData.friends || []).includes(targetUid)) {
                        throw new Error('D√©j√† amis');
                    }
                    
                    if ((currentRequests.sent || []).includes(targetUid)) {
                        throw new Error('Demande d√©j√† envoy√©e');
                    }
                    
                    if ((currentRequests.received || []).includes(targetUid)) {
                        throw new Error('Demande d√©j√† re√ßue de cette personne');
                    }
                    
                    // Mises √† jour atomiques
                    transaction.update(doc(db, 'users', currentUser.uid), {
                        'friendRequests.sent': arrayUnion(targetUid)
                    });
                    
                    transaction.update(doc(db, 'users', targetUid), {
                        'friendRequests.received': arrayUnion(currentUser.uid)
                    });
                });

                // Mettre √† jour le profil local
                if (!userProfile.friendRequests) userProfile.friendRequests = { sent: [], received: [] };
                if (!userProfile.friendRequests.sent) userProfile.friendRequests.sent = [];
                if (!userProfile.friendRequests.sent.includes(targetUid)) {
                    userProfile.friendRequests.sent.push(targetUid);
                }

                showMessage(`Demande d'amiti√© envoy√©e √† ${targetUserData.firstName} ${targetUserData.lastName} !`);
                await loadFriendRequests();

            } catch (error) {
                console.error('‚ùå Erreur envoi demande:', error);
                if (error.message === 'D√©j√† amis') {
                    showMessage('Vous √™tes d√©j√† amis avec cette personne', 'error');
                } else if (error.message === 'Demande d√©j√† envoy√©e') {
                    showMessage('Demande d√©j√† envoy√©e √† cette personne', 'error');
                } else if (error.message === 'Demande d√©j√† re√ßue de cette personne') {
                    showMessage('Cette personne vous a d√©j√† envoy√© une demande ! V√©rifiez vos demandes re√ßues.', 'error');
                } else {
                    showMessage('Erreur lors de l\'envoi de la demande', 'error');
                }
            }
        }

        // Accepter une demande d'amiti√©
        async function acceptFriendRequest(senderUid) {
            try {
                console.log('ü§ù Acceptation demande d\'amiti√© de:', senderUid);
                
                // Utiliser une transaction pour garantir la coh√©rence
                await runTransaction(db, async (transaction) => {
                    // Lire les documents actuels
                    const currentUserDoc = await transaction.get(doc(db, 'users', currentUser.uid));
                    const senderUserDoc = await transaction.get(doc(db, 'users', senderUid));
                    
                    if (!currentUserDoc.exists() || !senderUserDoc.exists()) {
                        throw new Error('Utilisateur non trouv√©');
                    }
                    
                    const currentUserData = currentUserDoc.data();
                    const senderUserData = senderUserDoc.data();
                    
                    // V√©rifications dans la transaction
                    const currentRequests = currentUserData.friendRequests || { sent: [], received: [] };
                    const senderRequests = senderUserData.friendRequests || { sent: [], received: [] };
                    
                    if (!(currentRequests.received || []).includes(senderUid)) {
                        throw new Error('Demande non trouv√©e');
                    }
                    
                    if ((currentUserData.friends || []).includes(senderUid)) {
                        throw new Error('D√©j√† amis');
                    }
                    
                    // Mises √† jour atomiques pour les deux utilisateurs
                    transaction.update(doc(db, 'users', currentUser.uid), {
                        friends: arrayUnion(senderUid),
                        'friendRequests.received': arrayRemove(senderUid)
                    });
                    
                    transaction.update(doc(db, 'users', senderUid), {
                        friends: arrayUnion(currentUser.uid),
                        'friendRequests.sent': arrayRemove(currentUser.uid)
                    });
                });

                // Mettre √† jour le profil local
                if (!userProfile.friends) userProfile.friends = [];
                if (!userProfile.friends.includes(senderUid)) {
                    userProfile.friends.push(senderUid);
                }
                if (userProfile.friendRequests && userProfile.friendRequests.received) {
                    userProfile.friendRequests.received = userProfile.friendRequests.received.filter(uid => uid !== senderUid);
                }

                showMessage('Demande d\'amiti√© accept√©e !');
                await loadFriendRequests();
                await loadConfirmedFriends();

            } catch (error) {
                console.error('‚ùå Erreur acceptation demande:', error);
                
                if (error.message === 'Demande non trouv√©e') {
                    showMessage('Demande non trouv√©e', 'error');
                } else if (error.message === 'D√©j√† amis') {
                    showMessage('Vous √™tes d√©j√† amis avec cette personne', 'error');
                } else {
                    showMessage('Erreur lors de l\'acceptation', 'error');
                }
                
                // Recharger les donn√©es pour remettre l'interface √† jour
                await loadFriendRequests();
            }
        }

        // Refuser une demande d'amiti√©
        async function rejectFriendRequest(senderUid) {
            try {
                console.log('‚ùå Refus demande d\'amiti√© de:', senderUid);
                
                // Utiliser une transaction pour garantir la coh√©rence
                await runTransaction(db, async (transaction) => {
                    // Lire les documents actuels
                    const currentUserDoc = await transaction.get(doc(db, 'users', currentUser.uid));
                    const senderUserDoc = await transaction.get(doc(db, 'users', senderUid));
                    
                    if (!currentUserDoc.exists() || !senderUserDoc.exists()) {
                        throw new Error('Utilisateur non trouv√©');
                    }
                    
                    const currentUserData = currentUserDoc.data();
                    const currentRequests = currentUserData.friendRequests || { sent: [], received: [] };
                    
                    if (!(currentRequests.received || []).includes(senderUid)) {
                        throw new Error('Demande non trouv√©e');
                    }
                    
                    // Mises √† jour atomiques
                    transaction.update(doc(db, 'users', currentUser.uid), {
                        'friendRequests.received': arrayRemove(senderUid)
                    });
                    
                    transaction.update(doc(db, 'users', senderUid), {
                        'friendRequests.sent': arrayRemove(currentUser.uid)
                    });
                });

                // Mettre √† jour le profil local
                if (userProfile.friendRequests && userProfile.friendRequests.received) {
                    userProfile.friendRequests.received = userProfile.friendRequests.received.filter(uid => uid !== senderUid);
                }

                showMessage('Demande d\'amiti√© refus√©e');
                await loadFriendRequests();

            } catch (error) {
                console.error('‚ùå Erreur refus demande:', error);
                
                if (error.message === 'Demande non trouv√©e') {
                    showMessage('Demande non trouv√©e', 'error');
                } else {
                    showMessage('Erreur lors du refus', 'error');
                }
                
                // Recharger les donn√©es
                await loadFriendRequests();
            }
        }

        // Supprimer un ami
        async function removeFriend(friendUid) {
            try {
                if (!confirm('√ätes-vous s√ªr de vouloir supprimer cet ami ?')) {
                    return;
                }

                // Supprimer des listes d'amis des deux utilisateurs
                await updateDoc(doc(db, 'users', currentUser.uid), {
                    friends: arrayRemove(friendUid)
                });

                await updateDoc(doc(db, 'users', friendUid), {
                    friends: arrayRemove(currentUser.uid)
                });

                // Mettre √† jour le profil local
                if (userProfile.friends) {
                    userProfile.friends = userProfile.friends.filter(uid => uid !== friendUid);
                }

                showMessage('Ami supprim√©');
                await loadConfirmedFriends();

            } catch (error) {
                console.error('Erreur suppression ami:', error);
                showMessage('Erreur lors de la suppression', 'error');
            }
        }

        // Afficher/Cacher le loading
        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('profile-content').classList.remove('hidden');
        }

        // G√©rer la soumission du formulaire
        async function handleProfileSubmit(event) {
            event.preventDefault();
            
            const submitBtn = document.getElementById('submit-btn');
            const originalText = submitBtn.textContent;
            
            try {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Sauvegarde...';

                // R√©cup√©rer les donn√©es du formulaire
                const formData = new FormData(event.target);
                const profileData = {
                    firstName: formData.get('firstName')?.trim(),
                    lastName: formData.get('lastName')?.trim(),
                    email: formData.get('email')?.trim(),
                    address: formData.get('address')?.trim(),
                    transportMode: formData.get('transportMode'),
                    preferences: formData.get('preferences')?.trim(),
                    profileCompleted: true,
                    lastUpdated: new Date().toISOString()
                };

                // Validation c√¥t√© client
                if (!profileData.firstName || !profileData.lastName || !profileData.email || 
                    !profileData.address || !profileData.transportMode || !profileData.preferences) {
                    showMessage('Veuillez remplir tous les champs obligatoires', 'error');
                    return;
                }

                // Validation email
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(profileData.email)) {
                    showMessage('Veuillez saisir une adresse email valide', 'error');
                    return;
                }

                // V√©rifier si l'adresse a chang√© pour g√©ocoder si n√©cessaire
                const addressChanged = !userProfile.address || userProfile.address.trim() !== profileData.address;
                
                if (addressChanged && profileData.address) {
                    try {
                        submitBtn.textContent = 'G√©olocalisation...';
                        
                        // G√©ocoder la nouvelle adresse
                        const response = await fetch('/api/geocode', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${await currentUser.getIdToken()}`
                            },
                            body: JSON.stringify({ address: profileData.address })
                        });

                        if (response.ok) {
                            const geoData = await response.json();
                            if (geoData.success) {
                                // Ajouter les coordonn√©es au profil
                                profileData.coordinates = {
                                    lat: geoData.location.lat,
                                    lng: geoData.location.lng,
                                    formatted_address: geoData.formatted_address,
                                    geocoded_at: new Date().toISOString()
                                };
                                console.log('Adresse g√©ocod√©e avec succ√®s:', profileData.coordinates);
                            } else {
                                console.warn('G√©ocodage √©chou√©:', geoData.error);
                                showMessage('Adresse g√©olocalis√©e avec difficult√©, v√©rifiez si elle est correcte', 'warning');
                            }
                        } else {
                            console.warn('Erreur API g√©ocodage');
                            showMessage('Probl√®me de g√©olocalisation, mais profil sauvegard√©', 'warning');
                        }
                    } catch (geoError) {
                        console.warn('Erreur g√©ocodage:', geoError);
                        showMessage('Probl√®me de g√©olocalisation, mais profil sauvegard√©', 'warning');
                    }
                } else if (!addressChanged && userProfile.coordinates) {
                    // Garder les coordonn√©es existantes si l'adresse n'a pas chang√©
                    profileData.coordinates = userProfile.coordinates;
                }

                submitBtn.textContent = 'Finalisation...';

                // Mise √† jour en base
                await updateDoc(doc(db, 'users', currentUser.uid), profileData);
                
                userProfile = { ...userProfile, ...profileData };
                
                showMessage('Profil mis √† jour avec succ√®s !');
                
                // Mettre √† jour le flag localement pour √©viter les probl√®mes de timing
                userProfile.profileCompleted = true;
                isNewUser = false;
                
                // Redirection vers dashboard apr√®s 1 seconde
                setTimeout(() => {
                    console.log('Redirecting to dashboard...');
                    window.location.href = 'dashboard.html';
                }, 1000);

            } catch (error) {
                console.error('Erreur sauvegarde profil:', error);
                showMessage('Erreur lors de la sauvegarde', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }

        // D√©connexion globale
        window.logout = async function() {
            try {
                await signOut(auth);
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Erreur d√©connexion:', error);
                showMessage('Erreur lors de la d√©connexion', 'error');
            }
        };

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Formulaire de profil
            const profileForm = document.getElementById('profile-form');
            if (profileForm) {
                profileForm.addEventListener('submit', handleProfileSubmit);
            }

            // Formulaire d'ajout d'ami
            const addFriendForm = document.getElementById('add-friend-form');
            if (addFriendForm) {
                addFriendForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const emailInput = document.getElementById('friend-email');
                    const email = emailInput.value.trim();
                    
                    if (email) {
                        await sendFriendRequest(email);
                        emailInput.value = ''; // Vider le champ apr√®s envoi
                    }
                });
            }
        });

        // Fonction utilitaire pour nettoyer les incoh√©rences (√† ex√©cuter au chargement)
        async function syncFriendRequestsData() {
            try {
                console.log('üîÑ Synchronisation des demandes d\'amis...');
                
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                if (!userDoc.exists()) return;
                
                const userData = userDoc.data();
                const requests = userData.friendRequests || { sent: [], received: [] };
                let needsUpdate = false;
                const updates = {};
                
                // Nettoyer les demandes envoy√©es (v√©rifier que les destinataires nous ont bien en "received")
                if (requests.sent && requests.sent.length > 0) {
                    const validSent = [];
                    for (const targetUid of requests.sent) {
                        try {
                            const targetDoc = await getDoc(doc(db, 'users', targetUid));
                            if (targetDoc.exists()) {
                                const targetData = targetDoc.data();
                                const targetRequests = targetData.friendRequests || { sent: [], received: [] };
                                
                                // V√©rifier si notre demande est bien dans ses demandes re√ßues
                                if ((targetRequests.received || []).includes(currentUser.uid)) {
                                    validSent.push(targetUid);
                                } else {
                                    console.log(`üßπ Demande envoy√©e orpheline supprim√©e: ${targetUid}`);
                                    needsUpdate = true;
                                }
                            } else {
                                console.log(`üßπ Utilisateur inexistant supprim√© des demandes envoy√©es: ${targetUid}`);
                                needsUpdate = true;
                            }
                        } catch (error) {
                            console.error(`Erreur v√©rification demande envoy√©e ${targetUid}:`, error);
                        }
                    }
                    if (validSent.length !== requests.sent.length) {
                        updates['friendRequests.sent'] = validSent;
                    }
                }
                
                // Nettoyer les demandes re√ßues (v√©rifier que les exp√©diteurs nous ont bien en "sent")
                if (requests.received && requests.received.length > 0) {
                    const validReceived = [];
                    for (const senderUid of requests.received) {
                        try {
                            const senderDoc = await getDoc(doc(db, 'users', senderUid));
                            if (senderDoc.exists()) {
                                const senderData = senderDoc.data();
                                const senderRequests = senderData.friendRequests || { sent: [], received: [] };
                                
                                // V√©rifier si notre UID est bien dans ses demandes envoy√©es
                                if ((senderRequests.sent || []).includes(currentUser.uid)) {
                                    validReceived.push(senderUid);
                                } else {
                                    console.log(`üßπ Demande re√ßue orpheline supprim√©e: ${senderUid}`);
                                    needsUpdate = true;
                                }
                            } else {
                                console.log(`üßπ Utilisateur inexistant supprim√© des demandes re√ßues: ${senderUid}`);
                                needsUpdate = true;
                            }
                        } catch (error) {
                            console.error(`Erreur v√©rification demande re√ßue ${senderUid}:`, error);
                        }
                    }
                    if (validReceived.length !== requests.received.length) {
                        updates['friendRequests.received'] = validReceived;
                    }
                }
                
                // Appliquer les corrections si n√©cessaire
                if (needsUpdate && Object.keys(updates).length > 0) {
                    await updateDoc(doc(db, 'users', currentUser.uid), updates);
                    console.log('‚úÖ Synchronisation des demandes d\'amis termin√©e avec corrections');
                    return true; // Indique qu'il y a eu des changements
                } else {
                    console.log('‚úÖ Synchronisation des demandes d\'amis termin√©e - aucune correction n√©cessaire');
                    return false;
                }
                
            } catch (error) {
                console.error('‚ùå Erreur lors de la synchronisation:', error);
                return false;
            }
        }

        // Exposer les fonctions globalement pour les √©v√©nements onclick
        window.acceptFriendRequest = acceptFriendRequest;
        window.rejectFriendRequest = rejectFriendRequest;
        window.removeFriend = removeFriend;
    </script>
</head>
<body>
    <div class="background-image"></div>
    <div class="profile-wrapper">
        
        <!-- Header commun -->
        <nav class="navbar">
            <div class="nav-left">
                <button onclick="window.location.href='dashboard.html'" class="nav-icon" title="Accueil">üè†</button>
                <span class="nav-icon nav-current" title="Profil">üë§</span>
            </div>
            <div class="nav-right">
                <button onclick="updateManager.forceCheck()" class="nav-update" title="V√©rifier les mises √† jour">üîÑ</button>
                <button onclick="logout()" class="nav-logout" title="D√©connexion">üö™</button>
            </div>
        </nav>
        
        <!-- Indicateur de chargement -->
        <div id="loading" class="loading">
            <h2>Chargement de votre profil...</h2>
            <div class="loading-spinner">‚è≥</div>
        </div>

        <!-- Contenu du profil -->
        <div id="profile-content" class="profile-content hidden">
            <!-- Section amis remont√©e -->
            <section class="friends-section">
                <h3>üë• Mes amis</h3>
                
                <!-- Ajouter un ami -->
                <div class="add-friend-form">
                    <h4>‚ûï Ajouter un ami</h4>
                    <form id="add-friend-form" class="inline-form">
                        <div class="form-group-inline">
                            <input type="email" id="friend-email" placeholder="Adresse email de votre ami" required>
                            <button type="submit" class="button button-secondary">Envoyer une demande</button>
                        </div>
                    </form>
                </div>

                <!-- Demandes re√ßues -->
                <div class="friend-requests-received">
                    <h4>üì• Demandes re√ßues</h4>
                    <div id="received-requests">
                        <!-- Les demandes re√ßues seront charg√©es ici -->
                    </div>
                </div>

                <!-- Demandes envoy√©es -->
                <div class="friend-requests-sent">
                    <h4>üì§ Demandes envoy√©es</h4>
                    <div id="sent-requests">
                        <!-- Les demandes envoy√©es seront charg√©es ici -->
                    </div>
                </div>

                <!-- Liste des amis -->
                <div class="friends-list-container">
                    <h4>‚úÖ Mes amis</h4>
                    <div id="friends-list">
                        <!-- Les amis seront charg√©s ici -->
                    </div>
                </div>
            </section>

            <!-- Formulaire de profil -->
            <form id="profile-form" class="profile-form">
                <!-- Informations personnelles -->
                <section class="form-section">
                    <h3>üë§ Informations personnelles</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="profile-firstName">Pr√©nom *</label>
                            <input type="text" id="profile-firstName" name="firstName" placeholder="Votre pr√©nom" required>
                        </div>
                        <div class="form-group">
                            <label for="profile-lastName">Nom *</label>
                            <input type="text" id="profile-lastName" name="lastName" placeholder="Votre nom" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="profile-email">Adresse e-mail *</label>
                        <input type="email" id="profile-email" name="email" placeholder="votre@email.com" required>
                    </div>
                </section>

                <!-- Informations de localisation -->
                <section class="form-section">
                    <h3>üìç Localisation</h3>
                    
                    <div class="form-group">
                        <label for="profile-address">Adresse *</label>
                        <input type="text" id="profile-address" name="address" placeholder="123 Rue de la Paix, 75000 Paris" required>
                    </div>
                </section>

                <!-- Transport -->
                <section class="form-section">
                    <h3>üöó Moyen de transport</h3>
                    
                    <div class="form-group">
                        <label for="profile-transport">Mode de transport *</label>
                        <select id="profile-transport" name="transportMode" required>
                            <option value="">S√©lectionnez votre moyen de transport</option>
                            <option value="bicycle">üö≤ V√©lo</option>
                            <option value="car">üöó Voiture</option>
                            <option value="public_transport">üöå Transport en commun</option>
                        </select>
                    </div>
                </section>

                <!-- Pr√©f√©rences -->
                <section class="form-section">
                    <h3>üç∫ Pr√©f√©rences</h3>
                    
                    <div class="form-group">
                        <label for="profile-preferences">Vos pr√©f√©rences *</label>
                        <textarea id="profile-preferences" name="preferences" rows="4" 
                                  placeholder="D√©crivez vos pr√©f√©rences : type d'ambiance, musique, nourriture, prix..." required></textarea>
                    </div>
                </section>

                <!-- Actions -->
                <div class="form-actions">
                    <button type="submit" id="submit-btn" class="button">
                        Sauvegarder mon profil
                    </button>
                </div>
            </form>
        </div>
    </div>
</body>
</html>
