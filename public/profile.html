<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Profil utilisateur - On va où ? Complétez vos informations">
    <meta name="theme-color" content="#5d4037">
    <title>Mon Profil - On va où ?</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="manifest" href="/manifest.json">
    <link rel="manifest" href="/site.webmanifest">
    
    <link rel="stylesheet" href="style.css">
    
    <style>
        /* Wrapper spécifique au profil - vraiment responsive */
        .profile-wrapper {
            width: 100%;
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        /* Header commun */
        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px) saturate(1.2);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 15px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            margin: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-update {
            background: none;
            border: none;
            color: #2196F3;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 8px;
            border-radius: 12px;
            min-width: 36px;
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-update:hover {
            background: rgba(33, 150, 243, 0.1);
            transform: scale(1.05) rotate(180deg);
        }

        .nav-icon {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: 12px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
            min-height: 40px;
        }

        .nav-icon:hover {
            background: rgba(93, 64, 55, 0.1);
            transform: scale(1.05);
        }

        .nav-current {
            background: rgba(93, 64, 55, 0.15);
            cursor: default;
        }

        .nav-current:hover {
            transform: none;
        }

        .nav-logout {
            background: none;
            border: none;
            color: #EA4335;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 8px;
            border-radius: 12px;
            min-width: 40px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-logout:hover {
            background: rgba(234, 67, 53, 0.1);
            transform: scale(1.05);
        }

        /* Container principal responsive */
        .profile-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            box-sizing: border-box;
        }

        /* Formulaire responsive en grid */
        .profile-form {
            display: grid;
            gap: 30px;
            grid-template-columns: 1fr;
        }

        /* Sections du formulaire */
        .form-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px) saturate(1.2);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .form-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .form-section h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: var(--primary-color);
            font-weight: 600;
            font-size: 20px;
        }

        /* Layout 2 colonnes sur desktop */
        @media (min-width: 1024px) {
            .profile-form {
                grid-template-columns: 1fr 1fr;
                gap: 40px;
            }
            
            .profile-content {
                padding: 0 40px;
            }
        }

        /* Tablet layout */
        @media (min-width: 769px) and (max-width: 1023px) {
            .profile-content {
                max-width: 900px;
                padding: 0 30px;
            }
            
            .profile-form {
                grid-template-columns: 1fr;
            }
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .profile-wrapper {
                padding: 0px 0;
            }
            
            .profile-content {
                padding: 0 15px;
            }
            
            .profile-header {
                padding: 20px;
                flex-direction: column;
                text-align: center;
                align-items: center;
                gap: 15px;
            }
            
            .profile-header h1 {
                font-size: 24px;
            }
            
            .header-actions {
                justify-content: center;
                width: 100%;
            }
            
            .form-section {
                padding: 20px;
                border-radius: 15px;
            }
            
            .form-section h3 {
                font-size: 18px;
            }
            
            .form-row {
                flex-direction: column;
            }
        }

        /* Section amis responsive */
        .friends-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px) saturate(1.2);
            border-radius: 20px;
            padding: 30px;
            margin-top: 30px;
            margin-bottom: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .friends-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        /* Loading screen amélioré */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .loading.hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* Classe hidden globale */
        .hidden {
            display: none !important;
        }

        /* Boutons responsifs */
        .button, .button-secondary, .button-logout {
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }

        /* Centrer le bouton de sauvegarde */
        .form-actions {
            text-align: center;
            padding: 20px 0;
        }

        @media (max-width: 768px) {
            .navbar {
                padding: 10px 15px;
            }

            .nav-left {
                gap: 15px;
            }

            .nav-icon {
                font-size: 20px;
                min-width: 36px;
                min-height: 36px;
            }

            .nav-logout {
                font-size: 20px;
                min-width: 36px;
                min-height: 36px;
            }

            .button, .button-secondary, .button-logout {
                padding: 10px 20px;
                font-size: 13px;
            }
        }
    </style>
    
    <!-- Firebase App (the core Firebase SDK) -->
    <script type="module">
        // Import du gestionnaire de mises à jour simplifié (temporaire)
        import './js/simple-update-manager.js';
        
        import { auth, db } from './firebase-config.js';
        import { onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
        import { doc, getDoc, setDoc, updateDoc, collection, query, where, getDocs, arrayUnion, arrayRemove, runTransaction } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

        // Fonction utilitaire pour afficher des messages
        function showMessage(message, type = 'success') {
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'error' ? 'error-message' : 
                                 type === 'warning' ? 'warning-message' : 'success-message';
            messageDiv.textContent = message;
            
            let backgroundColor;
            switch(type) {
                case 'error': backgroundColor = '#f44336'; break;
                case 'warning': backgroundColor = '#ff9800'; break;
                default: backgroundColor = '#4caf50'; break;
            }
            
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 1000;
                max-width: 400px;
                background: ${backgroundColor};
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        let currentUser = null;
        let userProfile = null;
        let isNewUser = false;

        // Vérifier l'authentification
        onAuthStateChanged(auth, async (user) => {
            console.log('onAuthStateChanged triggered:', user ? user.email : 'no user');
            if (user) {
                currentUser = user;
                await loadUserProfile();
            } else {
                console.log('No user found, redirecting to login');
                window.location.href = 'login.html';
            }
        });

        // Charger le profil utilisateur
        async function loadUserProfile() {
            console.log('Loading user profile for:', currentUser.uid);
            try {
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                console.log('User document exists:', userDoc.exists());
                if (userDoc.exists()) {
                    userProfile = userDoc.data();
                    
                    // Vérifier et réparer la structure du profil
                    const needsRepair = await checkAndRepairProfile();
                    
                    // Distinguer entre "vraiment nouveau" (pas de firstName/lastName) et "profil incomplet"
                    const hasBasicInfo = userProfile.firstName?.trim() && userProfile.lastName?.trim();
                    const hasCompleteProfile = hasBasicInfo && 
                                             userProfile.address?.trim() && 
                                             userProfile.transportMode?.trim() && 
                                             userProfile.preferences?.trim();
                    
                    // Si l'utilisateur a au moins un nom/prénom, ne pas le traiter comme "nouveau"
                    isNewUser = !hasBasicInfo;
                    
                    console.log('Profile check:', {
                        needsRepair,
                        hasBasicInfo,
                        hasCompleteProfile,
                        isNewUser,
                        profileCompleted: userProfile.profileCompleted,
                        firstName: userProfile.firstName,
                        lastName: userProfile.lastName
                    });
                    
                    updateUI();
                    hideLoading();
                    
                    // Charger les amis seulement si le profil est structurellement valide
                    if (!needsRepair) {
                        await loadFriends();
                    }
                } else {
                    // Nouvel utilisateur - créer un profil par défaut
                    console.log('Nouveau utilisateur détecté, création du profil par défaut...');
                    
                    userProfile = {
                        firstName: '',
                        lastName: '',
                        email: currentUser.email || '',
                        createdAt: new Date().toISOString(),
                        profileCompleted: false,
                        address: '',
                        transportMode: '',
                        preferences: '',
                        friends: [],
                        friendRequests: {
                            sent: [],
                            received: []
                        }
                    };
                    
                    try {
                        await setDoc(doc(db, 'users', currentUser.uid), userProfile);
                        console.log('Profil par défaut créé avec succès');
                    } catch (error) {
                        console.error('Erreur création profil par défaut:', error);
                        showMessage('Erreur lors de la création du profil', 'error');
                    }
                    
                    isNewUser = true;
                    updateUI();
                    hideLoading();
                }
            } catch (error) {
                console.error('Erreur chargement profil:', error);
                showMessage('Erreur lors du chargement des données', 'error');
                hideLoading(); // Important : arrêter le loading même en cas d'erreur
            }
        }

        // Vérifier et réparer la structure du profil
        async function checkAndRepairProfile() {
            let needsUpdate = false;
            let updates = {};
            
            // Vérifier les champs obligatoires manquants
            if (!userProfile.friends) {
                updates.friends = [];
                needsUpdate = true;
            }
            
            if (!userProfile.friendRequests) {
                updates.friendRequests = { sent: [], received: [] };
                needsUpdate = true;
            }
            
            if (!userProfile.firstName) {
                updates.firstName = '';
                needsUpdate = true;
            }
            
            if (!userProfile.lastName) {
                updates.lastName = '';
                needsUpdate = true;
            }
            
            if (!userProfile.email) {
                updates.email = currentUser.email || '';
                needsUpdate = true;
            }
            
            if (!userProfile.address) {
                updates.address = '';
                needsUpdate = true;
            }
            
            if (!userProfile.transportMode) {
                updates.transportMode = '';
                needsUpdate = true;
            }
            
            if (!userProfile.preferences) {
                updates.preferences = '';
                needsUpdate = true;
            }
            
            // Logique simplifiée pour profileCompleted
            const allCurrentFields = {
                firstName: userProfile.firstName || updates.firstName,
                lastName: userProfile.lastName || updates.lastName,
                email: userProfile.email || updates.email,
                address: userProfile.address || updates.address,
                transportMode: userProfile.transportMode || updates.transportMode,
                preferences: userProfile.preferences || updates.preferences
            };
            
            const hasAllRequiredFields = allCurrentFields.firstName?.trim() && 
                                        allCurrentFields.lastName?.trim() && 
                                        allCurrentFields.email?.trim() && 
                                        allCurrentFields.address?.trim() && 
                                        allCurrentFields.transportMode?.trim() && 
                                        allCurrentFields.preferences?.trim();
            
            // Déterminer la valeur correcte pour profileCompleted
            const shouldBeCompleted = hasAllRequiredFields;
            
            if (userProfile.profileCompleted !== shouldBeCompleted) {
                updates.profileCompleted = shouldBeCompleted;
                needsUpdate = true;
            }
            
            // Appliquer les mises à jour si nécessaire
            if (needsUpdate) {
                try {
                    await updateDoc(doc(db, 'users', currentUser.uid), updates);
                    // Mettre à jour le profil local
                    userProfile = { ...userProfile, ...updates };
                    console.log('Profil réparé automatiquement:', updates);
                } catch (error) {
                    console.error('Erreur réparation profil:', error);
                }
            }
            
            return needsUpdate;
        }

        // Mettre à jour l'interface
        function updateUI() {
            // Remplir les champs du formulaire
            const firstNameInput = document.getElementById('profile-firstName');
            const lastNameInput = document.getElementById('profile-lastName');
            const emailInput = document.getElementById('profile-email');
            const addressInput = document.getElementById('profile-address');
            const transportInput = document.getElementById('profile-transport');
            const preferencesInput = document.getElementById('profile-preferences');

            if (firstNameInput) firstNameInput.value = userProfile.firstName || '';
            if (lastNameInput) lastNameInput.value = userProfile.lastName || '';
            if (emailInput) emailInput.value = userProfile.email || '';
            if (addressInput) addressInput.value = userProfile.address || '';
            if (transportInput) transportInput.value = userProfile.transportMode || '';
            if (preferencesInput) preferencesInput.value = userProfile.preferences || '';
        }

        // Vérifier si le profil est complet
        function isProfileComplete() {
            return userProfile.profileCompleted && 
                   userProfile.firstName?.trim() && 
                   userProfile.lastName?.trim() && 
                   userProfile.email?.trim() && 
                   userProfile.address?.trim() && 
                   userProfile.transportMode?.trim() && 
                   userProfile.preferences?.trim();
        }

        // Charger la liste des amis et demandes
        async function loadFriends() {
            try {
                // D'abord synchroniser les données pour nettoyer les incohérences
                const hasChanges = await syncFriendRequestsData();
                
                // Recharger le profil si des corrections ont été apportées
                if (hasChanges) {
                    const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                    if (userDoc.exists()) {
                        userProfile = userDoc.data();
                    }
                }
                
                await loadFriendRequests();
                await loadConfirmedFriends();
            } catch (error) {
                console.error('Erreur chargement amis:', error);
            }
        }

        // Charger les demandes d'amitié
        async function loadFriendRequests() {
            try {
                // Demandes reçues
                const receivedContainer = document.getElementById('received-requests');
                const sentContainer = document.getElementById('sent-requests');
                
                // Assurer la structure correcte des friendRequests
                if (!userProfile.friendRequests) {
                    userProfile.friendRequests = { sent: [], received: [] };
                } else if (Array.isArray(userProfile.friendRequests)) {
                    // Migration de l'ancien système vers le nouveau
                    console.log('Migration de l\'ancien système détectée');
                    userProfile.friendRequests = { 
                        sent: [], 
                        received: userProfile.friendRequests 
                    };
                } else {
                    // Assurer que les propriétés existent
                    if (!userProfile.friendRequests.sent) userProfile.friendRequests.sent = [];
                    if (!userProfile.friendRequests.received) userProfile.friendRequests.received = [];
                }
                
                if (userProfile.friendRequests) {
                    // Demandes reçues
                    if (userProfile.friendRequests.received && userProfile.friendRequests.received.length > 0) {
                        const receivedHTML = await Promise.all(
                            userProfile.friendRequests.received.map(async (senderUid) => {
                                try {
                                    const senderDoc = await getDoc(doc(db, 'users', senderUid));
                                    if (senderDoc.exists()) {
                                        const senderData = senderDoc.data();
                                        return `
                                            <div class="friend-request-item">
                                                <span class="friend-name">${senderData.firstName} ${senderData.lastName}</span>
                                                <span class="friend-email">(${senderData.email})</span>
                                                <div class="request-actions">
                                                    <button onclick="acceptFriendRequest('${senderUid}')" class="button-small button-accept">Accepter</button>
                                                    <button onclick="rejectFriendRequest('${senderUid}')" class="button-small button-reject">Refuser</button>
                                                </div>
                                            </div>
                                        `;
                                    } else {
                                        console.warn('Utilisateur non trouvé:', senderUid);
                                        return '';
                                    }
                                } catch (error) {
                                    console.error('Erreur chargement expéditeur:', senderUid, error);
                                    return '';
                                }
                            })
                        );
                        receivedContainer.innerHTML = receivedHTML.join('');
                    } else {
                        receivedContainer.innerHTML = '<p class="no-requests">Aucune demande reçue</p>';
                    }

                    // Demandes envoyées
                    if (userProfile.friendRequests.sent && userProfile.friendRequests.sent.length > 0) {
                        const sentHTML = await Promise.all(
                            userProfile.friendRequests.sent.map(async (recipientUid) => {
                                const recipientDoc = await getDoc(doc(db, 'users', recipientUid));
                                const recipientData = recipientDoc.data();
                                return `
                                    <div class="friend-request-item">
                                        <span class="friend-name">${recipientData.firstName} ${recipientData.lastName}</span>
                                        <span class="friend-email">(${recipientData.email})</span>
                                        <span class="request-status">En attente...</span>
                                    </div>
                                `;
                            })
                        );
                        sentContainer.innerHTML = sentHTML.join('');
                    } else {
                        sentContainer.innerHTML = '<p class="no-requests">Aucune demande envoyée</p>';
                    }
                } else {
                    receivedContainer.innerHTML = '<p class="no-requests">Aucune demande reçue</p>';
                    sentContainer.innerHTML = '<p class="no-requests">Aucune demande envoyée</p>';
                }
            } catch (error) {
                console.error('Erreur chargement demandes:', error);
            }
        }

        // Charger les amis confirmés
        async function loadConfirmedFriends() {
            try {
                const friendsList = document.getElementById('friends-list');
                
                if (userProfile.friends && userProfile.friends.length > 0) {
                    const friendsHTML = await Promise.all(
                        userProfile.friends.map(async (friendUid) => {
                            const friendDoc = await getDoc(doc(db, 'users', friendUid));
                            const friendData = friendDoc.data();
                            return `
                                <div class="friend-item">
                                    <div class="friend-info">
                                        <span class="friend-name">${friendData.firstName} ${friendData.lastName}</span>
                                        <span class="friend-email">(${friendData.email})</span>
                                    </div>
                                    <button onclick="removeFriend('${friendUid}')" class="button-small button-remove">Supprimer</button>
                                </div>
                            `;
                        })
                    );
                    friendsList.innerHTML = friendsHTML.join('');
                } else {
                    friendsList.innerHTML = '<p class="no-friends">Aucun ami pour le moment</p>';
                }
            } catch (error) {
                console.error('Erreur chargement amis confirmés:', error);
            }
        }

        // Rechercher un utilisateur par email et envoyer une demande d'amitié
        async function sendFriendRequest(email) {
            try {
                // Vérifier que ce n'est pas son propre email
                if (email === currentUser.email) {
                    showMessage('Vous ne pouvez pas vous ajouter vous-même !', 'error');
                    return;
                }

                // Rechercher l'utilisateur par email
                const usersRef = collection(db, 'users');
                const q = query(usersRef, where('email', '==', email));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    showMessage('Aucun utilisateur trouvé avec cette adresse email', 'error');
                    return;
                }

                const targetUserDoc = querySnapshot.docs[0];
                const targetUserData = targetUserDoc.data();
                const targetUid = targetUserDoc.id;

                // Vérifier que les utilisateurs ne sont pas déjà amis
                if (userProfile.friends && userProfile.friends.includes(targetUid)) {
                    showMessage('Vous êtes déjà amis avec cette personne', 'error');
                    return;
                }

                // Vérifier qu'une demande n'a pas déjà été envoyée
                if (userProfile.friendRequests && userProfile.friendRequests.sent && userProfile.friendRequests.sent.includes(targetUid)) {
                    showMessage('Demande déjà envoyée à cette personne', 'error');
                    return;
                }

                // Vérifier qu'une demande n'a pas déjà été reçue de cette personne
                if (userProfile.friendRequests && userProfile.friendRequests.received && userProfile.friendRequests.received.includes(targetUid)) {
                    showMessage('Cette personne vous a déjà envoyé une demande ! Vérifiez vos demandes reçues.', 'error');
                    return;
                }

                // Utiliser une transaction pour garantir la cohérence
                console.log('📤 Envoi demande d\'amitié à:', targetUid);
                
                await runTransaction(db, async (transaction) => {
                    // Lire les documents actuels
                    const currentUserDoc = await transaction.get(doc(db, 'users', currentUser.uid));
                    const targetUserDoc = await transaction.get(doc(db, 'users', targetUid));
                    
                    if (!currentUserDoc.exists() || !targetUserDoc.exists()) {
                        throw new Error('Utilisateur non trouvé');
                    }
                    
                    const currentUserData = currentUserDoc.data();
                    const targetUserData = targetUserDoc.data();
                    
                    // Vérifications finales dans la transaction
                    const currentRequests = currentUserData.friendRequests || { sent: [], received: [] };
                    const targetRequests = targetUserData.friendRequests || { sent: [], received: [] };
                    
                    if ((currentUserData.friends || []).includes(targetUid)) {
                        throw new Error('Déjà amis');
                    }
                    
                    if ((currentRequests.sent || []).includes(targetUid)) {
                        throw new Error('Demande déjà envoyée');
                    }
                    
                    if ((currentRequests.received || []).includes(targetUid)) {
                        throw new Error('Demande déjà reçue de cette personne');
                    }
                    
                    // Mises à jour atomiques
                    transaction.update(doc(db, 'users', currentUser.uid), {
                        'friendRequests.sent': arrayUnion(targetUid)
                    });
                    
                    transaction.update(doc(db, 'users', targetUid), {
                        'friendRequests.received': arrayUnion(currentUser.uid)
                    });
                });

                // Mettre à jour le profil local
                if (!userProfile.friendRequests) userProfile.friendRequests = { sent: [], received: [] };
                if (!userProfile.friendRequests.sent) userProfile.friendRequests.sent = [];
                if (!userProfile.friendRequests.sent.includes(targetUid)) {
                    userProfile.friendRequests.sent.push(targetUid);
                }

                showMessage(`Demande d'amitié envoyée à ${targetUserData.firstName} ${targetUserData.lastName} !`);
                await loadFriendRequests();

            } catch (error) {
                console.error('❌ Erreur envoi demande:', error);
                if (error.message === 'Déjà amis') {
                    showMessage('Vous êtes déjà amis avec cette personne', 'error');
                } else if (error.message === 'Demande déjà envoyée') {
                    showMessage('Demande déjà envoyée à cette personne', 'error');
                } else if (error.message === 'Demande déjà reçue de cette personne') {
                    showMessage('Cette personne vous a déjà envoyé une demande ! Vérifiez vos demandes reçues.', 'error');
                } else {
                    showMessage('Erreur lors de l\'envoi de la demande', 'error');
                }
            }
        }

        // Accepter une demande d'amitié
        async function acceptFriendRequest(senderUid) {
            try {
                console.log('🤝 Acceptation demande d\'amitié de:', senderUid);
                
                // Utiliser une transaction pour garantir la cohérence
                await runTransaction(db, async (transaction) => {
                    // Lire les documents actuels
                    const currentUserDoc = await transaction.get(doc(db, 'users', currentUser.uid));
                    const senderUserDoc = await transaction.get(doc(db, 'users', senderUid));
                    
                    if (!currentUserDoc.exists() || !senderUserDoc.exists()) {
                        throw new Error('Utilisateur non trouvé');
                    }
                    
                    const currentUserData = currentUserDoc.data();
                    const senderUserData = senderUserDoc.data();
                    
                    // Vérifications dans la transaction
                    const currentRequests = currentUserData.friendRequests || { sent: [], received: [] };
                    const senderRequests = senderUserData.friendRequests || { sent: [], received: [] };
                    
                    if (!(currentRequests.received || []).includes(senderUid)) {
                        throw new Error('Demande non trouvée');
                    }
                    
                    if ((currentUserData.friends || []).includes(senderUid)) {
                        throw new Error('Déjà amis');
                    }
                    
                    // Mises à jour atomiques pour les deux utilisateurs
                    transaction.update(doc(db, 'users', currentUser.uid), {
                        friends: arrayUnion(senderUid),
                        'friendRequests.received': arrayRemove(senderUid)
                    });
                    
                    transaction.update(doc(db, 'users', senderUid), {
                        friends: arrayUnion(currentUser.uid),
                        'friendRequests.sent': arrayRemove(currentUser.uid)
                    });
                });

                // Mettre à jour le profil local
                if (!userProfile.friends) userProfile.friends = [];
                if (!userProfile.friends.includes(senderUid)) {
                    userProfile.friends.push(senderUid);
                }
                if (userProfile.friendRequests && userProfile.friendRequests.received) {
                    userProfile.friendRequests.received = userProfile.friendRequests.received.filter(uid => uid !== senderUid);
                }

                showMessage('Demande d\'amitié acceptée !');
                await loadFriendRequests();
                await loadConfirmedFriends();

            } catch (error) {
                console.error('❌ Erreur acceptation demande:', error);
                
                if (error.message === 'Demande non trouvée') {
                    showMessage('Demande non trouvée', 'error');
                } else if (error.message === 'Déjà amis') {
                    showMessage('Vous êtes déjà amis avec cette personne', 'error');
                } else {
                    showMessage('Erreur lors de l\'acceptation', 'error');
                }
                
                // Recharger les données pour remettre l'interface à jour
                await loadFriendRequests();
            }
        }

        // Refuser une demande d'amitié
        async function rejectFriendRequest(senderUid) {
            try {
                console.log('❌ Refus demande d\'amitié de:', senderUid);
                
                // Utiliser une transaction pour garantir la cohérence
                await runTransaction(db, async (transaction) => {
                    // Lire les documents actuels
                    const currentUserDoc = await transaction.get(doc(db, 'users', currentUser.uid));
                    const senderUserDoc = await transaction.get(doc(db, 'users', senderUid));
                    
                    if (!currentUserDoc.exists() || !senderUserDoc.exists()) {
                        throw new Error('Utilisateur non trouvé');
                    }
                    
                    const currentUserData = currentUserDoc.data();
                    const currentRequests = currentUserData.friendRequests || { sent: [], received: [] };
                    
                    if (!(currentRequests.received || []).includes(senderUid)) {
                        throw new Error('Demande non trouvée');
                    }
                    
                    // Mises à jour atomiques
                    transaction.update(doc(db, 'users', currentUser.uid), {
                        'friendRequests.received': arrayRemove(senderUid)
                    });
                    
                    transaction.update(doc(db, 'users', senderUid), {
                        'friendRequests.sent': arrayRemove(currentUser.uid)
                    });
                });

                // Mettre à jour le profil local
                if (userProfile.friendRequests && userProfile.friendRequests.received) {
                    userProfile.friendRequests.received = userProfile.friendRequests.received.filter(uid => uid !== senderUid);
                }

                showMessage('Demande d\'amitié refusée');
                await loadFriendRequests();

            } catch (error) {
                console.error('❌ Erreur refus demande:', error);
                
                if (error.message === 'Demande non trouvée') {
                    showMessage('Demande non trouvée', 'error');
                } else {
                    showMessage('Erreur lors du refus', 'error');
                }
                
                // Recharger les données
                await loadFriendRequests();
            }
        }

        // Supprimer un ami
        async function removeFriend(friendUid) {
            try {
                if (!confirm('Êtes-vous sûr de vouloir supprimer cet ami ?')) {
                    return;
                }

                // Supprimer des listes d'amis des deux utilisateurs
                await updateDoc(doc(db, 'users', currentUser.uid), {
                    friends: arrayRemove(friendUid)
                });

                await updateDoc(doc(db, 'users', friendUid), {
                    friends: arrayRemove(currentUser.uid)
                });

                // Mettre à jour le profil local
                if (userProfile.friends) {
                    userProfile.friends = userProfile.friends.filter(uid => uid !== friendUid);
                }

                showMessage('Ami supprimé');
                await loadConfirmedFriends();

            } catch (error) {
                console.error('Erreur suppression ami:', error);
                showMessage('Erreur lors de la suppression', 'error');
            }
        }

        // Afficher/Cacher le loading
        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('profile-content').classList.remove('hidden');
        }

        // Gérer la soumission du formulaire
        async function handleProfileSubmit(event) {
            event.preventDefault();
            
            const submitBtn = document.getElementById('submit-btn');
            const originalText = submitBtn.textContent;
            
            try {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Sauvegarde...';

                // Récupérer les données du formulaire
                const formData = new FormData(event.target);
                const profileData = {
                    firstName: formData.get('firstName')?.trim(),
                    lastName: formData.get('lastName')?.trim(),
                    email: formData.get('email')?.trim(),
                    address: formData.get('address')?.trim(),
                    transportMode: formData.get('transportMode'),
                    preferences: formData.get('preferences')?.trim(),
                    profileCompleted: true,
                    lastUpdated: new Date().toISOString()
                };

                // Validation côté client
                if (!profileData.firstName || !profileData.lastName || !profileData.email || 
                    !profileData.address || !profileData.transportMode || !profileData.preferences) {
                    showMessage('Veuillez remplir tous les champs obligatoires', 'error');
                    return;
                }

                // Validation email
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(profileData.email)) {
                    showMessage('Veuillez saisir une adresse email valide', 'error');
                    return;
                }

                // Vérifier si l'adresse a changé pour géocoder si nécessaire
                const addressChanged = !userProfile.address || userProfile.address.trim() !== profileData.address;
                
                if (addressChanged && profileData.address) {
                    try {
                        submitBtn.textContent = 'Géolocalisation...';
                        
                        // Géocoder la nouvelle adresse
                        const response = await fetch('/api/geocode', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${await currentUser.getIdToken()}`
                            },
                            body: JSON.stringify({ address: profileData.address })
                        });

                        if (response.ok) {
                            const geoData = await response.json();
                            if (geoData.success) {
                                // Ajouter les coordonnées au profil
                                profileData.coordinates = {
                                    lat: geoData.location.lat,
                                    lng: geoData.location.lng,
                                    formatted_address: geoData.formatted_address,
                                    geocoded_at: new Date().toISOString()
                                };
                                console.log('Adresse géocodée avec succès:', profileData.coordinates);
                            } else {
                                console.warn('Géocodage échoué:', geoData.error);
                                showMessage('Adresse géolocalisée avec difficulté, vérifiez si elle est correcte', 'warning');
                            }
                        } else {
                            console.warn('Erreur API géocodage');
                            showMessage('Problème de géolocalisation, mais profil sauvegardé', 'warning');
                        }
                    } catch (geoError) {
                        console.warn('Erreur géocodage:', geoError);
                        showMessage('Problème de géolocalisation, mais profil sauvegardé', 'warning');
                    }
                } else if (!addressChanged && userProfile.coordinates) {
                    // Garder les coordonnées existantes si l'adresse n'a pas changé
                    profileData.coordinates = userProfile.coordinates;
                }

                submitBtn.textContent = 'Finalisation...';

                // Mise à jour en base
                await updateDoc(doc(db, 'users', currentUser.uid), profileData);
                
                userProfile = { ...userProfile, ...profileData };
                
                showMessage('Profil mis à jour avec succès !');
                
                // Mettre à jour le flag localement pour éviter les problèmes de timing
                userProfile.profileCompleted = true;
                isNewUser = false;
                
                // Redirection vers dashboard après 1 seconde
                setTimeout(() => {
                    console.log('Redirecting to dashboard...');
                    window.location.href = 'dashboard.html';
                }, 1000);

            } catch (error) {
                console.error('Erreur sauvegarde profil:', error);
                showMessage('Erreur lors de la sauvegarde', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }

        // Déconnexion globale
        window.logout = async function() {
            try {
                await signOut(auth);
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Erreur déconnexion:', error);
                showMessage('Erreur lors de la déconnexion', 'error');
            }
        };

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Formulaire de profil
            const profileForm = document.getElementById('profile-form');
            if (profileForm) {
                profileForm.addEventListener('submit', handleProfileSubmit);
            }

            // Formulaire d'ajout d'ami
            const addFriendForm = document.getElementById('add-friend-form');
            if (addFriendForm) {
                addFriendForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const emailInput = document.getElementById('friend-email');
                    const email = emailInput.value.trim();
                    
                    if (email) {
                        await sendFriendRequest(email);
                        emailInput.value = ''; // Vider le champ après envoi
                    }
                });
            }
        });

        // Fonction utilitaire pour nettoyer les incohérences (à exécuter au chargement)
        async function syncFriendRequestsData() {
            try {
                console.log('🔄 Synchronisation des demandes d\'amis...');
                
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                if (!userDoc.exists()) return;
                
                const userData = userDoc.data();
                const requests = userData.friendRequests || { sent: [], received: [] };
                let needsUpdate = false;
                const updates = {};
                
                // Nettoyer les demandes envoyées (vérifier que les destinataires nous ont bien en "received")
                if (requests.sent && requests.sent.length > 0) {
                    const validSent = [];
                    for (const targetUid of requests.sent) {
                        try {
                            const targetDoc = await getDoc(doc(db, 'users', targetUid));
                            if (targetDoc.exists()) {
                                const targetData = targetDoc.data();
                                const targetRequests = targetData.friendRequests || { sent: [], received: [] };
                                
                                // Vérifier si notre demande est bien dans ses demandes reçues
                                if ((targetRequests.received || []).includes(currentUser.uid)) {
                                    validSent.push(targetUid);
                                } else {
                                    console.log(`🧹 Demande envoyée orpheline supprimée: ${targetUid}`);
                                    needsUpdate = true;
                                }
                            } else {
                                console.log(`🧹 Utilisateur inexistant supprimé des demandes envoyées: ${targetUid}`);
                                needsUpdate = true;
                            }
                        } catch (error) {
                            console.error(`Erreur vérification demande envoyée ${targetUid}:`, error);
                        }
                    }
                    if (validSent.length !== requests.sent.length) {
                        updates['friendRequests.sent'] = validSent;
                    }
                }
                
                // Nettoyer les demandes reçues (vérifier que les expéditeurs nous ont bien en "sent")
                if (requests.received && requests.received.length > 0) {
                    const validReceived = [];
                    for (const senderUid of requests.received) {
                        try {
                            const senderDoc = await getDoc(doc(db, 'users', senderUid));
                            if (senderDoc.exists()) {
                                const senderData = senderDoc.data();
                                const senderRequests = senderData.friendRequests || { sent: [], received: [] };
                                
                                // Vérifier si notre UID est bien dans ses demandes envoyées
                                if ((senderRequests.sent || []).includes(currentUser.uid)) {
                                    validReceived.push(senderUid);
                                } else {
                                    console.log(`🧹 Demande reçue orpheline supprimée: ${senderUid}`);
                                    needsUpdate = true;
                                }
                            } else {
                                console.log(`🧹 Utilisateur inexistant supprimé des demandes reçues: ${senderUid}`);
                                needsUpdate = true;
                            }
                        } catch (error) {
                            console.error(`Erreur vérification demande reçue ${senderUid}:`, error);
                        }
                    }
                    if (validReceived.length !== requests.received.length) {
                        updates['friendRequests.received'] = validReceived;
                    }
                }
                
                // Appliquer les corrections si nécessaire
                if (needsUpdate && Object.keys(updates).length > 0) {
                    await updateDoc(doc(db, 'users', currentUser.uid), updates);
                    console.log('✅ Synchronisation des demandes d\'amis terminée avec corrections');
                    return true; // Indique qu'il y a eu des changements
                } else {
                    console.log('✅ Synchronisation des demandes d\'amis terminée - aucune correction nécessaire');
                    return false;
                }
                
            } catch (error) {
                console.error('❌ Erreur lors de la synchronisation:', error);
                return false;
            }
        }

        // Exposer les fonctions globalement pour les événements onclick
        window.acceptFriendRequest = acceptFriendRequest;
        window.rejectFriendRequest = rejectFriendRequest;
        window.removeFriend = removeFriend;
    </script>
</head>
<body>
    <div class="background-image"></div>
    <div class="profile-wrapper">
        
        <!-- Header commun -->
        <nav class="navbar">
            <div class="nav-left">
                <button onclick="window.location.href='dashboard.html'" class="nav-icon" title="Accueil">🏠</button>
                <span class="nav-icon nav-current" title="Profil">👤</span>
            </div>
            <div class="nav-right">
                <button onclick="updateManager.forceCheck()" class="nav-update" title="Vérifier les mises à jour">🔄</button>
                <button onclick="logout()" class="nav-logout" title="Déconnexion">🚪</button>
            </div>
        </nav>
        
        <!-- Indicateur de chargement -->
        <div id="loading" class="loading">
            <h2>Chargement de votre profil...</h2>
            <div class="loading-spinner">⏳</div>
        </div>

        <!-- Contenu du profil -->
        <div id="profile-content" class="profile-content hidden">
            <!-- Section amis remontée -->
            <section class="friends-section">
                <h3>👥 Mes amis</h3>
                
                <!-- Ajouter un ami -->
                <div class="add-friend-form">
                    <h4>➕ Ajouter un ami</h4>
                    <form id="add-friend-form" class="inline-form">
                        <div class="form-group-inline">
                            <input type="email" id="friend-email" placeholder="Adresse email de votre ami" required>
                            <button type="submit" class="button button-secondary">Envoyer une demande</button>
                        </div>
                    </form>
                </div>

                <!-- Demandes reçues -->
                <div class="friend-requests-received">
                    <h4>📥 Demandes reçues</h4>
                    <div id="received-requests">
                        <!-- Les demandes reçues seront chargées ici -->
                    </div>
                </div>

                <!-- Demandes envoyées -->
                <div class="friend-requests-sent">
                    <h4>📤 Demandes envoyées</h4>
                    <div id="sent-requests">
                        <!-- Les demandes envoyées seront chargées ici -->
                    </div>
                </div>

                <!-- Liste des amis -->
                <div class="friends-list-container">
                    <h4>✅ Mes amis</h4>
                    <div id="friends-list">
                        <!-- Les amis seront chargés ici -->
                    </div>
                </div>
            </section>

            <!-- Formulaire de profil -->
            <form id="profile-form" class="profile-form">
                <!-- Informations personnelles -->
                <section class="form-section">
                    <h3>👤 Informations personnelles</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="profile-firstName">Prénom *</label>
                            <input type="text" id="profile-firstName" name="firstName" placeholder="Votre prénom" required>
                        </div>
                        <div class="form-group">
                            <label for="profile-lastName">Nom *</label>
                            <input type="text" id="profile-lastName" name="lastName" placeholder="Votre nom" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="profile-email">Adresse e-mail *</label>
                        <input type="email" id="profile-email" name="email" placeholder="votre@email.com" required>
                    </div>
                </section>

                <!-- Informations de localisation -->
                <section class="form-section">
                    <h3>📍 Localisation</h3>
                    
                    <div class="form-group">
                        <label for="profile-address">Adresse *</label>
                        <input type="text" id="profile-address" name="address" placeholder="123 Rue de la Paix, 75000 Paris" required>
                    </div>
                </section>

                <!-- Transport -->
                <section class="form-section">
                    <h3>🚗 Moyen de transport</h3>
                    
                    <div class="form-group">
                        <label for="profile-transport">Mode de transport *</label>
                        <select id="profile-transport" name="transportMode" required>
                            <option value="">Sélectionnez votre moyen de transport</option>
                            <option value="bicycle">🚲 Vélo</option>
                            <option value="car">🚗 Voiture</option>
                            <option value="public_transport">🚌 Transport en commun</option>
                        </select>
                    </div>
                </section>

                <!-- Préférences -->
                <section class="form-section">
                    <h3>🍺 Préférences</h3>
                    
                    <div class="form-group">
                        <label for="profile-preferences">Vos préférences *</label>
                        <textarea id="profile-preferences" name="preferences" rows="4" 
                                  placeholder="Décrivez vos préférences : type d'ambiance, musique, nourriture, prix..." required></textarea>
                    </div>
                </section>

                <!-- Actions -->
                <div class="form-actions">
                    <button type="submit" id="submit-btn" class="button">
                        Sauvegarder mon profil
                    </button>
                </div>
            </form>
        </div>
    </div>
</body>
</html>
